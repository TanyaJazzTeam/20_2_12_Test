---
"$title": Используйте AMP в качестве источника данных для PWA
"$order": '1'
description: Если вы вложили средства в AMP, но еще не создали прогрессивное веб-приложение, ваши страницы AMP могут значительно упростить разработку вашего прогрессивного веб-приложения.
formats:
  - веб-сайты
author: пбакаус
---

Если вы вложили средства в AMP, но еще не создали прогрессивное веб-приложение, ваши страницы AMP могут значительно упростить разработку вашего прогрессивного веб-приложения. В этом руководстве вы узнаете, как использовать AMP в своем прогрессивном веб-приложении и использовать существующие AMP-страницы в качестве источника данных.

## Из JSON в AMP

В наиболее распространенном сценарии прогрессивное веб-приложение - это одностраничное приложение, которое подключается к JSON API через Ajax. Затем этот JSON API возвращает наборы данных для управления навигацией и фактическое содержимое для отображения статей.

Тестовый сегмент 1

Затем вы должны преобразовать необработанный контент в пригодный для использования HTML и отобразить его на клиенте. Этот процесс дорогостоящий, и его часто трудно поддерживать. Вместо этого вы можете повторно использовать уже существующие AMP-страницы в качестве источника контента. Лучше всего то, что AMP позволяет сделать это всего лишь несколькими строками кода.

Тестовый сегмент 2

## Включите Shadow AMP в свое прогрессивное веб-приложение

Первый шаг - включить специальную версию AMP, которую мы называем «Shadow AMP», в ваше прогрессивное веб-приложение. Да, верно - вы загружаете библиотеку AMP на страницу верхнего уровня, но она фактически не контролирует контент верхнего уровня. Он только «расширит» те части нашей страницы, о которых вы ему говорите.

Включите Shadow AMP в заголовок своей страницы, например:

[исходный код: html]

<!-- Asynchronously load the AMP-with-Shadow-DOM runtime library. -->

&lt;script async="" src="https://cdn.ampproject.org/shadow-v0.js"&gt;&lt;/script&gt;

[/исходный код]

### Как узнать, что API Shadow AMP готов к использованию?

Мы рекомендуем вам загрузить библиотеку Shadow AMP с установленным атрибутом `async` . Однако это означает, что вам нужно использовать определенный подход, чтобы понять, когда библиотека полностью загружена и готова к использованию.

Правильный сигнал для наблюдения - это доступность глобальной переменной `AMP` , и Shadow AMP использует « [подход асинхронной загрузки функций](http://mrcoles.com/blog/google-analytics-asynchronous-tracking-how-it-work/) », чтобы помочь в этом. Рассмотрим этот код:

[исходный код: javascript] (window.AMP = window.AMP || []). push (function (AMP) {// AMP теперь доступен.}); [/исходный код]

Этот код будет работать, и любое количество обратных вызовов, добавленных таким образом, действительно будет срабатывать, когда AMP доступен, но почему?

Этот код переводится как:

1. «Если window.AMP не существует, создайте пустой массив, чтобы занять его позицию»
2. "затем вставьте в массив функцию обратного вызова, которая должна быть выполнена, когда AMP будет готов"

It works because the Shadow AMP library, upon actual load, will realize there's already an array of callbacks under `window.AMP`, then process the entire queue. If you later execute the same function again, it will still work, as Shadow AMP replaces `window.AMP` with itself and a custom `push` method that simply fires the callback right away.

[tip type = "tip"] **СОВЕТ.** Чтобы сделать приведенный выше пример кода практичным, мы рекомендуем вам обернуть его в Promise, а затем всегда использовать это обещание перед работой с AMP API. Посмотрите наш [демонстрационный код React](https://github.com/ampproject/amp-publisher-sample/blob/master/amp-pwa/src/components/amp-document/amp-document.js#L20) для примера. [/наконечник]

## Управляйте навигацией в своем прогрессивном веб-приложении

Вам все равно придется выполнить этот шаг вручную. В конце концов, вам решать, как вы представляете ссылки на контент в своей концепции навигации. Количество списков? Куча карточек?

В обычном сценарии вы получаете некоторый JSON, который возвращает упорядоченные URL-адреса с некоторыми метаданными. В конце концов, вы должны получить обратный вызов функции, который срабатывает, когда пользователь нажимает на одну из ссылок, и указанный обратный вызов должен включать URL-адрес запрошенной страницы AMP. Если он у вас есть, вы готовы к последнему шагу.

## Используйте API Shadow AMP для рендеринга страницы в строке

Наконец, если вы хотите отобразить контент после действия пользователя, пора получить соответствующий документ AMP и позволить Shadow AMP взять на себя управление. Сначала реализуйте функцию для получения страницы, подобную этой:

[исходный код: javascript] function fetchDocument (url) {

// к сожалению, fetch () не поддерживает получение документов, // поэтому нам приходится прибегать к старому доброму XMLHttpRequest. var xhr = новый XMLHttpRequest ();

вернуть новое обещание (функция (разрешить, отклонить) {xhr.open ('GET', url, true); xhr.responseType = 'document'; xhr.setRequestHeader ('Accept', 'text / html'); xhr.onload = function () {// .responseXML содержит готовый к использованию объект Document resolve (xhr.responseXML);}; xhr.send ();}); } [/исходный код]

[tip type = "important"] **ВАЖНО -** Чтобы упростить приведенный выше пример кода, мы пропустили обработку ошибок. Вы всегда должны следить за тем, чтобы правильно вылавливать и обрабатывать ошибки. [/наконечник]

Теперь, когда у нас есть готовый к использованию объект `Document` , пора позволить AMP взять на себя его рендеринг. Получите ссылку на элемент DOM, который служит контейнером для документа AMP, затем вызовите `AMP.attachShadowDoc()` , например:

[исходный код: javascript] // Это может быть любой элемент DOM var container = document.getElementById ('container');

// AMP-страница, которую вы хотите отображать var url = "https: //my-domain/amp/an-article.html";

// Используйте наш метод fetchDocument для получения документа fetchDocument (url) .then (function (doc) {// Позвольте AMP взять на себя управление и отобразить страницу var ampedDoc = AMP.attachShadowDoc (container, doc, url);}); [/исходный код]

[tip type = "tip"] **СОВЕТ.** Прежде чем фактически передать документ AMP, самое время удалить элементы страницы, которые имеют смысл при отображении страницы AMP в автономном режиме, но не во встроенном режиме: например, нижние колонтитулы и заголовки. . [/наконечник]

И это все! Ваша AMP-страница отображается как дочерняя для вашего общего прогрессивного веб-приложения.

## Убирайся за собой

Скорее всего, ваш пользователь перейдет с AMP на AMP в вашем прогрессивном веб-приложении. При отказе от предыдущей обработанной страницы AMP всегда сообщайте об этом AMP, например:

[исходный код: javascript] // ampedDoc - это ссылка, возвращаемая из AMP.attachShadowDoc ampedDoc.close (); [/исходный код]

Это сообщит AMP, что вы больше не используете этот документ, и освободит память и нагрузку на ЦП.

## Смотрите в действии

[video src = "/ static / img / docs / pwamp_react_demo.mp4" width = "620" height = "1100" loop = "true", controls = "true"]

Вы можете увидеть шаблон «AMP в PWA» в действии в созданном нами [примере React](https://github.com/ampproject/amp-publisher-sample/tree/master/amp-pwa) . Он демонстрирует плавные переходы во время навигации и поставляется с простым компонентом React, который завершает описанные выше шаги. Это лучшее из обоих миров - гибкий настраиваемый JavaScript в прогрессивном веб-приложении и AMP для управления контентом.

- Загрузите исходный код здесь: [https://github.com/ampproject/amp-publisher-sample/tree/master/amp-pwa](https://github.com/ampproject/amp-publisher-sample/tree/master/amp-pwa)
- Используйте автономный компонент React через npm: [https://www.npmjs.com/package/react-amp-document](https://www.npmjs.com/package/react-amp-document)
- Посмотрите, как это работает здесь: [https://choumx.github.io/amp-pwa/](https://choumx.github.io/amp-pwa/) (лучше всего на телефоне или в мобильной эмуляции)

Вы также можете увидеть образец PWA и AMP с использованием Polymer framework. В примере используется [amp-viewer](https://github.com/PolymerLabs/amp-viewer/) для встраивания AMP-страниц.

- Возьмите код здесь: [https://github.com/Polymer/news/tree/amp](https://github.com/Polymer/news/tree/amp)
- Посмотреть в действии можно здесь: [https://polymer-news-amp.appspot.com/](https://polymer-news-amp.appspot.com/)
