---
"$title": Используйте AMP в качестве источника данных для PWA
"$order": один
description: Если вы вложили средства в AMP, но еще не создали прогрессивное веб-приложение, ваши страницы AMP могут значительно упростить разработку вашего прогрессивного веб-приложения.
formats:
  - Веб-сайты
author: Pbackaus
---

Если вы вложили средства в AMP, но еще не создали прогрессивное веб-приложение, ваши страницы AMP могут значительно упростить разработку вашего прогрессивного веб-приложения. В этом руководстве вы узнаете, как использовать AMP в своем прогрессивном веб-приложении и использовать существующие страницы AMP в качестве источника данных.

## JSON в AMP

В наиболее распространенном сценарии прогрессивное веб-приложение - это одностраничное приложение, которое подключается к JSON API через Ajax. Затем этот JSON API возвращает наборы данных для управления навигацией и фактический контент для отображения статей.

Тестовый сегмент 1

Затем вам нужно преобразовать необработанный контент в пригодный для использования HTML и отобразить его на клиенте. Этот процесс дорогостоящий и часто сложный в обслуживании. Вместо этого вы можете повторно использовать существующие AMP-страницы в качестве источника контента. Лучше всего то, что AMP позволяет сделать это с помощью всего нескольких строк кода.

Тестовый сегмент 2

## Включите Shadow AMP в свое прогрессивное веб-приложение

Первый шаг - включить специальную версию AMP, которую мы называем «Shadow AMP», в ваше прогрессивное веб-приложение. Да, верно - вы загружаете библиотеку AMP на страницу верхнего уровня, но на самом деле она не контролирует контент верхнего уровня. Он будет «расширять» только те части нашей страницы, о которых вы ему рассказываете.

Включите Shadow AMP в заголовок своей страницы, например:

[исходный код: html]

<!-- Asynchronously load the AMP-with-Shadow-DOM runtime library. -->

&lt;script async = "" src = "https://cdn.ampproject.org/shadow-v0.js"&gt; &lt;/script&gt;

[/источник]

### Как я узнаю, что Shadow AMP API готов к использованию?

Мы рекомендуем вам загрузить библиотеку Shadow AMP с установленным атрибутом `async` Однако это означает, что вам нужно использовать особый подход, чтобы понять, когда библиотека полностью загружена и готова к использованию.

Правильный сигнал для наблюдения - это доступность глобальной `AMP` , и Shadow AMP использует " [подход асинхронной загрузки функций](http://mrcoles.com/blog/google-analytics-asynchronous-tracking-how-it-work/) ", чтобы помочь в этом. Рассмотрим этот код:

[источник: javascript] (window.AMP = window.AMP || []). push (function (AMP) {// AMP теперь доступен.}); [/источник]

Этот код будет работать, и любое количество обратных вызовов, добавленных таким образом, действительно сработает, когда AMP доступен, но почему?

Этот код переводится как:

1. «Если window.AMP не существует, создайте пустой массив, который займет его позицию».
2. "затем вставьте функцию обратного вызова в массив, которая будет выполнена, когда AMP будет готов".

Это работает, потому что библиотека Shadow AMP при фактической загрузке поймет, что в `window.AMP` уже есть массив обратных вызовов, а затем обработает всю очередь. Если позже вы снова выполните ту же функцию, она все равно будет работать, поскольку Shadow AMP заменяет `window.AMP` самим собой и настраиваемым `push` который просто сразу запускает обратный вызов.

[tip type = "tip"] **СОВЕТ.** Чтобы сделать приведенный выше пример кода практичным, мы рекомендуем вам обернуть его в Promise, а затем всегда использовать это обещание перед работой с AMP API. Посмотрите наш [демонстрационный код React](https://github.com/ampproject/amp-publisher-sample/blob/master/amp-pwa/src/components/amp-document/amp-document.js#L20) для примера. [/Подсказка]

## Управляйте навигацией в своем прогрессивном веб-приложении

Вам все равно придется выполнить этот шаг вручную. В конце концов, вам решать, как вы представляете ссылки на контент в своей концепции навигации. Количество списков? Много карточек?

В типичном сценарии вы получаете некоторый JSON, который возвращает упорядоченные URL-адреса с некоторыми метаданными. В конечном итоге вы должны получить обратный вызов функции, который срабатывает, когда пользователь нажимает на одну из ссылок, и указанный обратный вызов должен включать URL-адрес запрошенной страницы AMP. Если он у вас есть, вы готовы к последнему шагу.

## Используйте API Shadow AMP для рендеринга страницы в строке

Наконец, если вы хотите отображать контент после действий пользователя, пора получить соответствующий документ AMP и позволить Shadow AMP взять на себя управление. Сначала реализуйте функцию для получения такой страницы:

[источник: javascript] function fetchDocument (url) {

// к сожалению, fetch () не поддерживает выборку документов, // поэтому нам приходится прибегать к старому доброму XMLHttpRequest. var xhr = новый XMLHttpRequest ();

вернуть новое обещание (функция (разрешить, отклонить) {xhr.open ('GET', url, true); xhr.responseType = 'document'; xhr.setRequestHeader ('Accept', 'text / html'); xhr.onload = function () {// .responseXML содержит готовый к использованию объект Document resolve (xhr.responseXML);}; xhr.send ();}); } [/источник]

[tip type = "important"] **ВАЖНО -** Чтобы упростить приведенный выше пример кода, мы опустили обработку ошибок. Вы всегда должны быть осторожны, чтобы правильно выявлять и обрабатывать ошибки. [/Подсказка]

Теперь, когда у нас есть `Document` готовый к использованию, пора позволить AMP взять на себя рендеринг. Получите ссылку на элемент DOM, который служит контейнером для документа AMP, затем вызовите `AMP.attachShadowDoc()` , например:

[источник: javascript] // Это может быть любой элемент DOM var container = document.getElementById ('container');

// AMP-страница, которую вы хотите отображать var url = "https: //my-domain/amp/an-article.html";

// Используйте наш метод fetchDocument для получения документа fetchDocument (url) .then (function (doc) {// Позвольте AMP взять на себя и отобразить страницу var ampedDoc = AMP.attachShadowDoc (container, doc, url);}); [/источник]

[tip type = "tip"] **СОВЕТ.** Перед фактической отправкой документа AMP пора удалить элементы страницы, которые имеют смысл при отрисовке страницы AMP в автономном режиме, но не встроенной: например, нижние колонтитулы и заголовки. ... [/Подсказка]

И все это! Ваша AMP-страница отображается как дочерняя страница вашего стандартного прогрессивного веб-приложения.

## Выходи за собой

Скорее всего, ваш пользователь переключится с AMP на AMP в вашем прогрессивном веб-приложении. При отказе от ранее созданной AMP-страницы всегда сообщайте об этом AMP, например:

[источник: javascript] // ampedDoc - это ссылка, возвращаемая из AMP.attachShadowDoc ampedDoc.close (); [/источник]

Это проинформирует AMP о том, что вы больше не используете этот документ, и освободит память и использование ЦП.

## Посмотреть в действии

[video src = "/ static / img / docs / pwamp_react_demo.mp4" width = "620" height = "1100" loop = "true", controls = "true"]

Вы можете увидеть шаблон AMP в PWA в действии в созданном нами [примере React.](https://github.com/ampproject/amp-publisher-sample/tree/master/amp-pwa) Он демонстрирует плавные переходы во время навигации и поставляется с простым компонентом React, который выполняет описанные выше шаги. Это лучшее из обоих миров - гибкий настраиваемый JavaScript в прогрессивном веб-приложении и AMP для управления контентом.

- Загрузите исходный код здесь: [https://github.com/ampproject/amp-publisher-sample/tree/master/amp-pwa](https://github.com/ampproject/amp-publisher-sample/tree/master/amp-pwa)
- Используйте автономный компонент React через npm: [https://www.npmjs.com/package/react-amp-document](https://www.npmjs.com/package/react-amp-document)
- Посмотрите, как это работает, здесь: [https://choumx.github.io/amp-pwa/](https://choumx.github.io/amp-pwa/) (лучше всего для эмуляции телефона или мобильного телефона)

Вы также можете увидеть образцы PWA и AMP, используя платформу Polymer. В этом примере для встраивания AMP-страниц [используется amp-viewer.](https://github.com/PolymerLabs/amp-viewer/)

- Возьмите код здесь: [https://github.com/Polymer/news/tree/amp](https://github.com/Polymer/news/tree/amp)
- Посмотрите, как это работает здесь: [https://polymer-news-amp.appspot.com/](https://polymer-news-amp.appspot.com/)
